name: Configurator CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  configurator-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate configurator entry points
        run: |
          set -euo pipefail
          python tools/validate_metadata.py
          python tools/configure.py --help >/dev/null
          python tools/configure.py --list-modules >/dev/null
          python tools/configure.py --list-boards >/dev/null

      - name: Generate config for every board
        run: |
          set -euo pipefail
          mkdir -p tmp/ci/config-check

          while IFS='|' read -r platform board_dir; do
            outdir="tmp/ci/config-check/${platform}/${board_dir}"
            mkdir -p "$outdir"
            echo "[ci] checking ${platform}/${board_dir}"
            python tools/configure.py \
              --platform "$platform" \
              --board "$board_dir" \
              --outdir "$outdir"

            test -f "$outdir/basalt_config.h"
            test -f "$outdir/basalt.features.json"
            test -f "$outdir/sdkconfig.defaults"
          done < <(
            find boards -name board.json -print \
              | sed -E 's#^boards/([^/]+)/([^/]+)/board\.json$#\1|\2#' \
              | sort
          )

      - name: Validate board.sh selectors
        run: |
          set -euo pipefail
          bash -n tools/board.sh
          bash tools/board.sh --list >/dev/null
