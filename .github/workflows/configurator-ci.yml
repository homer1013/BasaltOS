name: Configurator CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  configurator-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CI dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install flask flask-cors
          npm init -y >/dev/null 2>&1 || true
          npm install --no-audit --no-fund playwright@1.51.1
          npx playwright install chromium

      - name: Validate configurator entry points
        run: |
          set -euo pipefail
          python tools/validate_metadata.py
          python tools/configure.py --help >/dev/null
          python tools/configure.py --list-modules >/dev/null
          python tools/configure.py --list-boards >/dev/null

      - name: Configure CLI smoke tests
        run: |
          set -euo pipefail
          bash tools/tests/configure_invalid_board_regression.sh
          bash tools/tests/configure_negative_paths.sh
          bash tools/tests/configure_smoke_multi_board.sh
          bash tools/tests/configure_deterministic_outputs.sh

      - name: Validate board.sh selectors
        run: |
          set -euo pipefail
          bash -n tools/board.sh
          bash tools/board.sh --list >/dev/null

      - name: Configurator API smoke
        run: |
          set -euo pipefail
          bash tools/tests/configurator_api_smoke.sh

      - name: Configurator E2E smoke
        run: |
          set -euo pipefail
          BASALTOS_LOCAL_MARKET_ENABLED=1 python -c 'from tools import basaltos_config_server as srv; srv.app.run(debug=False, use_reloader=False, host="127.0.0.1", port=5000)' > /tmp/basalt_config_server.log 2>&1 &
          SERVER_PID=$!
          cleanup() {
            kill "$SERVER_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for _ in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:5000/ >/dev/null; then
              echo "server ready"
              break
            fi
            sleep 0.5
          done
          curl -fsS http://127.0.0.1:5000/ >/dev/null || { echo "server failed to start"; exit 1; }

          BASALT_UI_URL=http://127.0.0.1:5000 node tools/e2e/smoke_configurator.js
