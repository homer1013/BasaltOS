name: Configurator CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  configurator-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CI dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install flask flask-cors
          npm init -y >/dev/null 2>&1 || true
          npm install --no-audit --no-fund playwright@1.51.1
          npx playwright install chromium

      - name: Validate configurator entry points
        run: |
          set -euo pipefail
          python tools/validate_metadata.py
          bash tools/tests/validate_metadata_report_regression.sh
          python tools/configure.py --help >/dev/null
          python tools/configure.py --list-modules >/dev/null
          python tools/configure.py --list-boards >/dev/null

      - name: Configure CLI smoke tests
        run: |
          set -euo pipefail
          bash tools/tests/run_s2_cli_matrix.sh
          bash tools/tests/configure_invalid_board_regression.sh
          bash tools/tests/platformio_phase1_contract.sh
          bash tools/tests/configure_bme280_smoke.sh
          bash tools/tests/configure_mcp2515_smoke.sh
          bash tools/tests/configure_mcp2515_config_validation.sh
          bash tools/tests/configure_esp32s3_reference_smoke.sh
          bash tools/tests/export_local_sync_payload_smoke.sh
          bash tools/tests/sync_payload_tooling_smoke.sh
          bash tools/tests/metadata_completeness_report_smoke.sh
          bash tools/tests/metadata_taxonomy_drift_smoke.sh
          python3 tools/metadata_completeness_report.py --fail-under 95 --out tmp/metadata/board_completeness_report.md
          bash tools/tests/release_sync_check_smoke.sh
          bash tools/tests/release_sync_update_smoke.sh
          bash tools/tests/shell_ux_polish_smoke.sh
          bash tools/tests/esp32_first_success_quickstart_smoke.sh
          bash tools/tests/examples_pack_recipes_smoke.sh
          bash tools/tests/staged_artifact_guard_smoke.sh
          bash tools/tests/generation_parity_baseline_drift_smoke.sh
          bash tools/tests/generation_parity_defaults_gate_smoke.sh
          bash tools/tests/driver_capability_matrix_drift_smoke.sh
          bash tools/tests/board_catalog_drift_smoke.sh
          bash tools/tests/board_taxonomy_fields_smoke.sh

      - name: Upload S2 CLI acceptance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: s2-cli-acceptance
          path: tmp/acceptance/s2-cli/
          if-no-files-found: warn

      - name: Validate board.sh selectors
        run: |
          set -euo pipefail
          bash -n tools/board.sh
          bash tools/board.sh --list >/dev/null

      - name: Configurator API smoke
        run: |
          set -euo pipefail
          bash tools/tests/configurator_api_smoke.sh

      - name: Configurator E2E local-mode guard + smoke
        run: |
          set -euo pipefail
          python -c 'from tools import basaltos_config_server as srv; srv.app.run(debug=False, use_reloader=False, host="127.0.0.1", port=5000)' > /tmp/basalt_config_server.log 2>&1 &
          SERVER_PID=$!
          cleanup() {
            kill "$SERVER_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for _ in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:5000/ >/dev/null; then
              echo "server ready"
              break
            fi
            sleep 0.5
          done
          curl -fsS http://127.0.0.1:5000/ >/dev/null || { echo "server failed to start"; exit 1; }

          BASALT_UI_URL=http://127.0.0.1:5000 node tools/e2e/local_mode_nav_guard.js
          BASALT_UI_URL=http://127.0.0.1:5000 node tools/e2e/smoke_configurator.js

  lua-runtime-smoke:
    runs-on: ubuntu-latest
    container: espressif/idf:release-v5.5
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lua runtime CI smoke lane
        run: |
          set -euo pipefail
          chmod +x tools/tests/lua_runtime_ci_smoke.sh
          bash tools/tests/lua_runtime_ci_smoke.sh
