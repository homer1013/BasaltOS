#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
from collections import Counter
from pathlib import Path
from typing import Any, Dict, List, Set


def read_json(path: Path) -> Dict[str, Any]:
    return json.loads(path.read_text(encoding="utf-8"))


def load_boards(root: Path) -> List[Dict[str, Any]]:
    out: List[Dict[str, Any]] = []
    for board_json in sorted((root / "boards").rglob("board.json")):
        data = read_json(board_json)
        out.append(
            {
                "board_id": str(data.get("id") or board_json.parent.name),
                "platform": str(data.get("platform") or ""),
                "manufacturer": str(data.get("manufacturer") or "Unknown"),
                "mcu": str(data.get("mcu") or ""),
                "capabilities": {str(x).strip() for x in (data.get("capabilities") or []) if str(x).strip()},
                "path": str(board_json.relative_to(root)),
            }
        )
    return out


def load_contract(root: Path) -> Dict[str, Any]:
    mod = read_json(root / "modules" / "tp4056" / "module.json")
    return {
        "platforms": sorted([str(x).strip() for x in (mod.get("platforms") or []) if str(x).strip()]),
        "depends": [str(x).strip() for x in (mod.get("depends") or []) if str(x).strip()],
        "pins": [str(x).strip() for x in (mod.get("pins") or []) if str(x).strip()],
    }


def build_report(boards: List[Dict[str, Any]], contract: Dict[str, Any]) -> Dict[str, Any]:
    supported_platforms: Set[str] = set(contract["platforms"])
    enabled: List[Dict[str, Any]] = []
    intentional_missing: List[Dict[str, Any]] = []
    enabled_out_of_scope_actionable: List[Dict[str, Any]] = []

    for b in boards:
        has_mod = "tp4056" in b["capabilities"]
        row = {
            "board_id": b["board_id"],
            "platform": b["platform"],
            "manufacturer": b["manufacturer"],
            "mcu": b["mcu"],
        }
        if has_mod:
            enabled.append(row)
            if b["platform"] not in supported_platforms:
                enabled_out_of_scope_actionable.append(row)
        else:
            intentional_missing.append(row)

    return {
        "version": "1.0.0",
        "policy": {
            "intentional_boundary": "Missing `tp4056` is intentional unless a board profile explicitly opts into charger-pin posture.",
            "actionable_boundary": "`tp4056` capability declared outside module/tp4056 platform scope.",
        },
        "tp4056_module_contract": contract,
        "summary": {
            "board_count": len(boards),
            "tp4056_enabled_count": len(enabled),
            "tp4056_missing_intentional_count": len(intentional_missing),
            "actionable_total": len(enabled_out_of_scope_actionable),
            "tp4056_enabled_by_platform": dict(sorted(Counter(x["platform"] for x in enabled).items())),
            "tp4056_missing_by_platform": dict(sorted(Counter(x["platform"] for x in intentional_missing).items())),
        },
        "lists": {
            "tp4056_enabled": sorted(enabled, key=lambda x: (x["platform"], x["board_id"])),
            "tp4056_missing_intentional": sorted(intentional_missing, key=lambda x: (x["platform"], x["board_id"])),
            "tp4056_enabled_out_of_scope_actionable": sorted(
                enabled_out_of_scope_actionable, key=lambda x: (x["platform"], x["board_id"])
            ),
        },
    }


def write_md(report: Dict[str, Any], out_path: Path) -> None:
    s = report["summary"]
    lines: List[str] = []
    lines.append("# TP4056 Capability Posture Report v1")
    lines.append("")
    lines.append("Auto-generated by `tools/generate_tp4056_posture_report.py`.")
    lines.append("")
    lines.append("## Policy Boundaries")
    lines.append("")
    lines.append(f"- Intentional: {report['policy']['intentional_boundary']}")
    lines.append(f"- Actionable: {report['policy']['actionable_boundary']}")
    lines.append("")
    lines.append("## Summary")
    lines.append("")
    lines.append(f"- Boards analyzed: {int(s['board_count'])}")
    lines.append(f"- Boards with `tp4056` capability: {int(s['tp4056_enabled_count'])}")
    lines.append(f"- Boards missing `tp4056` (intentional): {int(s['tp4056_missing_intentional_count'])}")
    lines.append(f"- Actionable total: {int(s['actionable_total'])}")
    lines.append("")

    actionable = report["lists"]["tp4056_enabled_out_of_scope_actionable"]
    if actionable:
        lines.append("## Actionable: TP4056 Enabled Outside Module Platform Scope")
        lines.append("")
        for row in actionable:
            lines.append(f"- {row['platform']}/{row['board_id']} ({row['manufacturer']})")
        lines.append("")

    lines.append("## TP4056 Enabled Boards")
    lines.append("")
    for row in report["lists"]["tp4056_enabled"]:
        lines.append(f"- {row['platform']}/{row['board_id']} ({row['manufacturer']}, MCU: {row['mcu']})")
    lines.append("")

    lines.append("## Intentional Queue Snapshot (Top 30)")
    lines.append("")
    for row in report["lists"]["tp4056_missing_intentional"][:30]:
        lines.append(f"- {row['platform']}/{row['board_id']} ({row['manufacturer']})")
    lines.append("")

    out_path.parent.mkdir(parents=True, exist_ok=True)
    out_path.write_text("\n".join(lines).rstrip() + "\n", encoding="utf-8")


def main() -> int:
    ap = argparse.ArgumentParser(description="Generate TP4056 capability posture report artifacts.")
    ap.add_argument("--json-out", default="docs/planning/TP4056_CAPABILITY_POSTURE.json")
    ap.add_argument("--md-out", default="docs/planning/TP4056_CAPABILITY_POSTURE.md")
    args = ap.parse_args()

    root = Path(__file__).resolve().parent.parent
    report = build_report(load_boards(root), load_contract(root))
    json_out = (root / args.json_out).resolve()
    md_out = (root / args.md_out).resolve()
    json_out.parent.mkdir(parents=True, exist_ok=True)
    json_out.write_text(json.dumps(report, indent=2) + "\n", encoding="utf-8")
    write_md(report, md_out)

    print(f"[tp4056-posture] boards: {report['summary']['board_count']}")
    print(f"[tp4056-posture] tp4056-enabled: {report['summary']['tp4056_enabled_count']}")
    print(f"[tp4056-posture] actionable: {report['summary']['actionable_total']}")
    print(f"[tp4056-posture] wrote: {json_out}")
    print(f"[tp4056-posture] wrote: {md_out}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
